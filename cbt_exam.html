<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Exam - Academic Nightingale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            color: #374151; /* Tailwind gray-700 */
            background-color: #f0f4f8; /* Light blue-gray background */
            overscroll-behavior: none; /* Prevents pull-to-refresh issues on mobile */
        }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .bg-primary-teal { background-color: #0D9488; }
        .text-primary-teal { color: #0D9488; }
        .site-logo { height: 36px; width: auto; margin-right: 0.5rem; } /* Slightly smaller logo for nav */

        /* Consistent Button Styling */
        .btn {
            padding: 0.5rem 1rem; /* Reduced padding for smaller base size */
            border-radius: 0.375rem; font-weight: 600;
            font-family: 'Montserrat', sans-serif; transition: all 0.2s ease-in-out;
            text-transform: uppercase; letter-spacing: 0.05em; display: inline-flex;
            align-items: center; justify-content: center; font-size: 0.75rem; /* Smaller base font size */
            cursor: pointer;
            line-height: 1.25; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #0D9488; color: white; }
        .btn-primary:hover { background-color: #0F766E; }
        .btn-primary:disabled { background-color: #9CA3AF; cursor: not-allowed; box-shadow: none; transform: none;}
        .btn-secondary { background-color: #E0E7FF; color: #3730A3; border: 1px solid #C7D2FE; }
        .btn-secondary:hover { background-color: #C7D2FE; color: #312E81; }
        .btn-secondary:disabled { color: #9CA3AF; border-color: #D1D5DB; background-color: #F3F4F6; box-shadow: none; transform: none;}
        .btn-danger { background-color: #EF4444; color: white; }
        .btn-danger:hover { background-color: #DC2626; }
        .btn-warning { background-color: #F59E0B; color: white; }
        .btn-warning:hover { background-color: #D97706; }
        .btn-icon { padding: 0.5rem; font-size: 0.8rem; } /* Smaller icon button padding */
        .btn-filter { background-color: #E5E7EB; color: #374151; font-size: 0.7rem; padding: 0.3rem 0.6rem; text-transform: capitalize; }
        .btn-filter.active { background-color: #0D9488; color: white; }


        .nav-auth-item { display: none; }
        .nav-auth-item.active { display: inline-block; }
        .nav-user-email { font-size: 0.8rem; color: #4B5563; margin-right: 0.5rem; }
        .message-card { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); text-align: center; margin: 1rem; }

        /* Exam Layout - Base for larger screens */
        .exam-layout { display: flex; flex-direction: column; height: calc(100vh - 56px); } /* Adjusted for slightly smaller header */
        #exam-top-bar {
            background-color: #ffffff; padding: 0.5rem 1rem; border-bottom: 1px solid #e5e7eb;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); min-height: 50px; /* Reduced min-height */
        }
        #progress-container { display: flex; align-items: center; font-size: 0.75rem; color: #4B5563; flex-shrink: 0; margin-right: auto;}
        #progress-bar-wrapper { width: 100px; height: 6px; background-color: #e5e7eb; border-radius: 3px; overflow: hidden; margin-left: 0.5rem; }
        #progress-bar-fill { width: 0%; height: 100%; background-color: #0D9488; transition: width 0.3s ease; }
        #exam-timer-top { font-size: 0.9rem; font-weight: 700; color: #DC2626; font-family: 'Montserrat', sans-serif; margin: 0 0.75rem; flex-shrink: 0;}
        .exam-actions { display: flex; align-items: center; flex-wrap: nowrap; }
        .exam-actions .btn, .exam-actions .btn-icon { margin-left: 0.25rem; white-space: nowrap; } /* Reduced margin */
        #network-status-indicator { font-size: 0.7rem; padding: 0.2rem 0.4rem; border-radius: 0.25rem; margin-left: 0.75rem; }
        #network-status-indicator.online { background-color: #D1FAE5; color: #065F46; }
        #network-status-indicator.offline { background-color: #FEE2E2; color: #991B1B; }


        .exam-main-area { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        #question-navigation-panel {
            width: 200px; /* Slightly reduced width */
            background-color: #f9fafb; border-right: 1px solid #e5e7eb;
            padding: 0.75rem; 
            display: flex; flex-direction: column;
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, max-height 0.3s ease-in-out; /* Added max-height transition */
            transform: translateX(0);
            overflow-y: auto; /* Ensure scrolling is enabled by default for desktop if content overflows */
        }
        #question-navigation-panel.hidden-desktop { /* Specific class for desktop hiding */
            transform: translateX(-100%);
            width: 0; /* Collapse width when hidden on desktop */
            padding: 0;
            border-right: none;
        }
        .nav-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;}
        .nav-panel-title { font-size: 0.7rem; text-transform: uppercase; color: #6b7280; font-weight: 600; }
        .question-nav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); gap: 0.3rem; } /* Smaller items */
        .question-nav-item {
            width: 100%; height: 32px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.8rem;
            cursor: pointer; transition: all 0.2s ease; background-color: white;
            position: relative;
        }
        .question-nav-item .fa-flag { font-size: 0.6rem; color: #EF4444; position: absolute; top: 2px; right: 2px;}
        .question-nav-item:hover { border-color: #0D9488; background-color: #f0fdfa; }
        .question-nav-item.current { background-color: #0D9488; color: white; border-color: #0D9488; font-weight: bold; }
        .question-nav-item.answered { background-color: #A7F3D0; border-color: #059669; color: #047857; }
        .question-nav-item.seen { background-color: #FFFFFF; border-color: #D1D5DB; color: #4B5563; }
        .question-nav-item.unseen { background-color: #FFFFFF; border-color: #D1D5DB; color: #4B5563; }
        .question-nav-item.review-correct { background-color: #A7F3D0 !important; border-color: #059669 !important; color: #047857 !important; }
        .question-nav-item.review-incorrect { background-color: #FEE2E2 !important; border-color: #EF4444 !important; color: #991B1B !important; }
        .question-nav-item.review-skipped { background-color: #FEF3C7 !important; border-color: #F59E0B !important; color: #B45309 !important; }
        .question-nav-item.review-current { outline: 2px solid #3B82F6; outline-offset: 1px; }


        #main-exam-content {
            flex-grow: 1; padding: 1rem 1.5rem; /* Reduced padding */
            overflow-y: auto; background-color: #ffffff;
            transition: margin-left 0.3s ease-in-out;
        }
        
        #active-exam-view.hidden, #results-view-wrapper.hidden { display: none; }

        #question-container {
            background-color: #E0F7FA; padding: 1rem; /* Reduced padding */
            border-radius: 0.5rem; margin-bottom: 1.25rem;
            border-left: 4px solid #00796B; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        #examTitleContextInPage { font-size: 0.8rem; color: #004D40; margin-bottom: 0.5rem; font-weight: 500; }
        #question-text { font-size: 1.1rem; line-height: 1.6; color: #263238; font-family: 'Montserrat', sans-serif; font-weight: 500; } /* Adjusted font size */
        .question-header-actions { margin-bottom: 0.5rem; text-align: right; }

        #quiz-content-area.all-questions-view { padding: 0.25rem; }
        .all-questions-view .question-block { margin-bottom: 1.5rem; padding: 0; border: none; box-shadow: none; }
        .all-questions-view .question-block #question-container { margin-bottom: 0.75rem; }
        .all-questions-view .single-question-text-header { font-size: 1rem; font-family: 'Montserrat', sans-serif; font-weight: 600; margin-bottom: 0.25rem; color: #00796B;}
        .all-questions-view #question-container #question-text { font-size: 1rem; font-weight: 500; }
        .all-questions-view .single-question-options { margin-top: 0.75rem;}


        #options-container, .single-question-options { /* space-y-0.5rem; Tailwind class was here, now handled by margin on labels */ }
        .quiz-option-label {
            display: flex; align-items: center; padding: 0.75rem 1rem; /* Reduced padding */
            border: 1px solid #D1D5DB; border-radius: 0.375rem;
            cursor: pointer; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
            background-color: #fff; font-size: 0.9rem; /* Smaller option text */
            margin-bottom: 0.5rem; /* Replaces space-y for direct children */
        }
        .quiz-option-label:last-child { margin-bottom: 0; }
        .quiz-option-label:hover { background-color: #F9FAFB; border-color: #A5B4FC; box-shadow: 0 0 0 1px rgba(165, 180, 252, 0.2); }
        .quiz-option-label.selected { background-color: #E0E7FF; border-color: #6366F1; font-weight: 500; box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3); }
        .quiz-option-input { margin-right: 0.5rem; width: 1rem; height: 1rem; accent-color: #0D9488; }

        #exam-bottom-navigation {
            margin-top: 1.5rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
        }
        #exam-bottom-navigation.hidden { display: none; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0s 0.3s linear;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); max-width: 480px; width: 90%;
            transform: translateY(-10px) scale(0.98); opacity: 0;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .modal-title { font-size: 1.25rem; font-weight: 700; font-family: 'Montserrat'; margin-bottom: 0.75rem; color: #1f2937;}
        .modal-body p { margin-bottom: 0.75rem; color: #4B5563; line-height: 1.5; font-size: 0.9rem;}
        .modal-actions { margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* Enhanced Results Styling */
        #results-view-wrapper { padding: 0.75rem 0; }
        .results-summary-card {
            background-color: #fff; padding: 1rem; border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 1.5rem;
            text-align: center;
        }
        .results-summary-card h2 { font-family: 'Montserrat', sans-serif; color: #0D9488; font-size: 1.5rem; margin-bottom: 0.75rem;}
        .score-display-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: center; margin: 1rem 0; }

        .score-overall .score-value-main { font-size: 2.5rem; font-weight: 800; color: #0D9488; line-height: 1; }
        .score-overall .score-total-main { font-size: 0.9rem; color: #6B7280; }

        .score-percentage-container {
            color: white; padding: 0.5rem 1rem; border-radius: 0.375rem;
            display: inline-block; margin-top: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 100px;
        }
        .score-percentage-container.pass { background-color: #0D9488; }
        .score-percentage-container.fail { background-color: #DC2626; }
        .score-percentage-main { font-size: 1.5rem; font-weight: 700; font-family: 'Montserrat'; }

        .exam-info-details { font-size: 0.8rem; color: #4B5563; margin-top: 0.75rem; line-height: 1.5; }
        .exam-info-details span { font-weight: 600; color: #1F2937; }

        .score-breakdown-list { list-style: none; padding: 0; margin-top: 1rem; }
        .score-breakdown-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; font-size: 0.9rem; border-bottom: 1px solid #f3f4f6;}
        .score-breakdown-list li:last-child { border-bottom: none; }
        .score-breakdown-list li .label::before { content: ''; display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 0.5rem; }
        .score-breakdown-list li .label.correct::before { background-color: #10B981; }
        .score-breakdown-list li .label.wrong::before { background-color: #EF4444; }
        .score-breakdown-list li .label.skipped::before { background-color: #F59E0B; }
        .score-breakdown-list li .count { font-weight: 600; color: #374151; }
        .results-summary-card .text-xs.text-gray-500 { margin-top: 1rem; font-style: italic; } /* Adjusted from text-sm */

        #review-filter-buttons { margin-bottom: 1rem; display: flex; gap: 0.3rem; flex-wrap: wrap; justify-content: center; }

        .detailed-results-container { margin-top: 1rem; }
        .result-question-item {
            background-color: #FFFFFF; padding: 1rem; border-radius: 0.375rem;
            margin-bottom: 1rem; border: 1px solid #E5E7EB; box-shadow: 0 2px 5px rgba(0,0,0,0.07);
        }
        .result-question-item .result-question-text-container {
            background-color: #E8EAF6; padding: 1rem;
            border-radius: 0.25rem; margin-bottom: 0.75rem; border-left: 4px solid #3F51B5;
        }
        .result-question-text { font-weight: 500; font-size: 1rem; color: #1A237E; font-family: 'Montserrat', sans-serif; }
        .result-options-list li {
            padding: 0.5rem 0.6rem; border-bottom: 1px solid #F3F4F6;
            border-radius: 0.25rem; margin-bottom: 0.2rem; display: flex;
            justify-content: space-between; align-items: center; transition: background-color 0.2s;
            font-size: 0.85rem; /* Smaller option text in review */
        }
        .result-options-list li:hover { background-color: #f9fafb; }
        .result-options-list li:last-child { border-bottom: none; }
        .result-option-indicator { margin-left: 0.5rem; font-size: 0.75rem; font-weight: 500; white-space: nowrap;}
        .result-option.correct-answer-style { color: #065F46; background-color: #D1FAE5; }
        .result-option.user-selected-style.incorrect-answer-style { background-color: #FEE2E2; color: #991B1B; }
        .result-option.user-selected-style.correct-answer-style { font-weight: bold; }
        .result-rationale {
            margin-top: 0.75rem; padding: 0.75rem; background-color: #f0f4f8;
            border-radius: 0.25rem; font-size: 0.85rem; border-left: 3px solid #0D9488;
            color: #374151; line-height: 1.5;
        }
        .result-rationale strong { font-family: 'Montserrat', sans-serif; color: #0F766E;}


        /* Responsive Adjustments for Mobile */
        @media (max-width: 768px) {
            .exam-layout { height: calc(100vh - 50px); } /* Adjusted for smaller header */
            #exam-top-bar {
                flex-direction: column; align-items: stretch; height: auto; padding: 0.5rem 0.75rem;
                min-height: auto; /* Allow it to shrink */
            }
            #exam-top-bar > div { margin-bottom: 0.5rem; } /* Space between stacked items */
            #exam-top-bar > div:last-child { margin-bottom: 0; }

            #progress-container { order: 1; width: 100%; justify-content: space-between; font-size: 0.7rem;}
            #progress-bar-wrapper { flex-grow: 1; margin-left: 0.5rem; height: 5px;}
            #exam-timer-top { order: 2; text-align: center; margin: 0.25rem 0; width: 100%; font-size: 0.85rem;}
            .exam-actions {
                order: 3; width: 100%; display: flex; justify-content: space-around; margin-top: 0.25rem;
                flex-wrap: wrap; /* Allow buttons to wrap if too many */
            }
            .exam-actions .btn, .exam-actions .btn-icon {
                margin-left: 0.2rem; margin-right: 0.2rem; /* Adjust spacing */
                padding: 0.4rem 0.8rem; /* Slightly smaller buttons */
                font-size: 0.7rem;
            }
             .exam-actions .btn-icon { padding: 0.4rem; }


            .exam-main-area { flex-direction: column; }
            #question-navigation-panel {
                width: 100%; 
                max-height: 0px; /* Start collapsed */
                order: -1; 
                padding: 0; 
                border-right: none; 
                border-bottom: 1px solid #e5e7eb;
                transform: translateY(0); 
                overflow-y: hidden; /* Initially hidden, JS will change to auto */
                transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out, opacity 0.3s ease-in-out;
                opacity: 0;
                position: static; /* Ensure it's part of the flow */
            }
            #question-navigation-panel.mobile-visible { /* Class to show panel on mobile */
                max-height: 200px; /* Increased max-height for better visibility of more items */
                padding: 0.5rem;
                opacity: 1;
                overflow-y: auto; /* Enable scrolling when visible and content overflows */
            }
            .question-nav-grid { 
                grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); /* Slightly smaller items for mobile */
                gap: 0.25rem; /* Adjusted gap */
            }
            .question-nav-item { 
                width: 100%; /* Ensure items take full grid cell width */
                height: 30px; /* Slightly smaller height */
                font-size: 0.75rem; /* Adjusted font size */
            }
            #main-exam-content { padding: 0.75rem; }
            #question-container { padding: 0.75rem; margin-bottom: 1rem;}
            #question-text { font-size: 1rem; line-height: 1.5; }
            .all-questions-view #question-container #question-text { font-size: 0.9rem; }
            .result-question-item { padding: 0.75rem; }
            .result-question-text { font-size: 0.9rem; }

            .score-overall .score-value-main { font-size: 2rem; }
            .score-percentage-main { font-size: 1.3rem; }
            .score-percentage-container { padding: 0.4rem 0.8rem; }
            .score-display-grid {grid-template-columns: 1fr; text-align:center;}
            .modal-content { padding: 1rem; }
            .modal-title { font-size: 1.1rem; }
            .modal-body p { font-size: 0.85rem; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 py-2.5 flex justify-between items-center h-[56px]">
            <a href="index.html#home" class="flex items-center text-xl font-montserrat font-bold text-primary-teal">
                <img src="https://i.ibb.co/nNgF9T4T/Adobe-Express-file.png" alt="Academic Nightingale Logo" class="site-logo" onerror="this.onerror=null;this.src='https://placehold.co/150x36/0D9488/FFFFFF?text=Logo&font=montserrat';this.alt='Error loading logo';">
            </a>
            <div id="navAuthLinksCBT" class="flex items-center space-x-2">
                <span id="navUserEmailCBT" class="nav-auth-item nav-user-email"></span>
                <button id="navLogoutCBT" class="nav-auth-item btn btn-secondary !text-xs !py-1 !px-2">Logout</button>
                <a href="index.html" id="navHomeCBT" class="text-gray-600 hover:text-primary-teal font-medium ml-1 text-xs sm:text-sm">Back to Home</a>
            </div>
        </nav>
    </header>

    <main class="pt-[56px]">
        <div id="cbtLoadingMessage" class="message-card max-w-md mx-auto mt-8">
            <div role="status" class="flex justify-center items-center mb-3">
                <svg aria-hidden="true" class="w-7 h-7 text-gray-200 animate-spin dark:text-gray-600 fill-primary-teal" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 40.0107 89.3758 44.3488 88.7555 48.5437C88.2905 51.9706 87.1743 55.3379 85.4778 58.3718C84.8704 59.5098 83.9066 60.3978 82.7311 60.972C81.5556 61.5462 80.2297 61.7881 78.9079 61.676C76.3438 61.4343 74.0441 59.9769 72.5564 57.8117C71.0687 55.6466 70.4806 52.9878 70.9138 50.426C71.347 47.8642 72.7926 45.5576 75.0342 44.0095C77.2759 42.4614 80.0691 41.8387 82.8148 42.2466C83.8542 42.3948 84.8707 42.138 85.7529 41.5279C86.6351 40.9178 87.3532 40.0039 87.8314 39.0409Z" fill="currentFill"/></svg>
                <span class="sr-only">Loading...</span>
            </div>
            <p id="loadingStatusText" class="text-lg text-gray-600">Loading exam...</p>
        </div>

        <div id="accessDeniedMessage" class="message-card max-w-md mx-auto mt-8 hidden">
            <h2 class="text-xl font-montserrat font-semibold text-red-500 mb-3">Access Denied</h2>
            <p class="text-gray-700 mb-5 text-sm">You do not have an active subscription to access the CBT exam. Please purchase a plan to continue.</p>
            <a href="exam-plans.html" class="btn btn-primary btn-sm">View Exam Plans</a>
        </div>

        <div id="cbtPageContent" class="exam-layout hidden">
            <div id="exam-top-bar">
                <div class="flex items-center flex-grow mb-2 sm:mb-0">
                    <button id="toggle-nav-panel-btn" class="btn btn-secondary btn-icon mr-2" title="Toggle Question Navigation">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div id="progress-container">
                        <span id="question-progress-text">Q: 0/0</span>
                        <div id="progress-bar-wrapper"><div id="progress-bar-fill"></div></div>
                    </div>
                </div>
                <div id="exam-timer-top" class="my-1 sm:my-0">Time: 00:00</div>
                 <div class="exam-actions">
                    <span id="network-status-indicator" class="online mr-2">Online</span>
                    <button id="view-mode-btn" class="btn btn-secondary !text-xs" title="Toggle View Mode">One by One</button>
                    <button id="calculator-btn" class="btn btn-secondary btn-icon !text-xs" title="Calculator"><i class="fas fa-calculator"></i></button>
                    <button id="help-btn" class="btn btn-secondary btn-icon !text-xs" title="Help/Instructions"><i class="fas fa-question-circle"></i></button>
                    <button id="submit-exam-early-btn" class="btn btn-danger !text-xs">Submit</button>
                </div>
            </div>

            <div class="exam-main-area">
                <aside id="question-navigation-panel" class="hidden-desktop"> <div class="nav-panel-header">
                        <h3 class="nav-panel-title">Question Map</h3>
                        <span id="nav-answered-count" class="text-xs text-gray-500">0/0 Answered</span>
                    </div>
                    <div id="question-nav-grid" class="question-nav-grid"></div>
                </aside>
                <section id="main-exam-content">
                    <div id="active-exam-view">
                        <div id="quiz-content-area" class="single-question-view"></div>
                        <div id="exam-bottom-navigation" class="mt-4 flex justify-between items-center">
                            <button id="prev-question-btn" class="btn btn-secondary">Previous</button>
                            <button id="next-question-btn" class="btn btn-primary">Next</button>
                        </div>
                    </div>
                    <div id="results-view-wrapper" class="hidden"></div>
                </section>
            </div>
        </div>

        <div id="submitConfirmationModal" class="modal-overlay">
            <div class="modal-content">
                <h2 class="modal-title">Confirm Submission</h2>
                <div class="modal-body"><p>Are you sure you want to submit your exam?</p></div>
                <div class="modal-actions">
                    <button id="cancelSubmitBtn" class="btn btn-secondary !text-xs">Cancel</button>
                    <button id="confirmSubmitBtn" class="btn btn-danger !text-xs">Yes, Submit</button>
                </div>
            </div>
        </div>
        <div id="instructionsModal" class="modal-overlay">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="modal-title">Exam Instructions</h2>
                    <button id="closeInstructionsBtn" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                </div>
                <div class="modal-body text-xs text-left max-h-[60vh] overflow-y-auto">
                    <p>Welcome to the CBT exam!</p>
                    <ul class="list-disc list-inside space-y-1.5 my-2">
                        <li>Use the <strong>Question Map</strong> (toggle with <i class="fas fa-bars"></i>/<i class="fas fa-times"></i> button) to navigate.</li>
                        <li>The <strong>Timer</strong> shows remaining time. Auto-submits if time runs out.</li>
                        <li>Use <strong>"Previous"</strong> & <strong>"Next"</strong> in "One by One" view.</li>
                        <li>Click <strong>"View All"</strong> (or "One by One") to toggle display modes.</li>
                        <li>Flag questions for review using the <i class="far fa-flag"></i> button.</li>
                        <li>Click <strong>"Submit Exam"</strong> (top bar) to finish.</li>
                        <li>A basic <strong>Calculator</strong> is available (<i class="fas fa-calculator"></i>).</li>
                        <li>Your progress is saved automatically to our servers.</li>
                    </ul>
                    <p>Good luck!</p>
                </div>
                 <div class="modal-actions">
                    <button id="gotItInstructionsBtn" class="btn btn-primary !text-xs">Got it!</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut, 
            signInAnonymously, // For anonymous sign-in if __initial_auth_token is not available
            signInWithCustomToken // For custom token sign-in
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc,
            query, 
            where, 
            getDocs, 
            Timestamp,
            serverTimestamp, // For server-side timestamps
            onSnapshot, // For real-time updates (optional for this phase, but good for future)
            enableNetwork, // To manually enable network
            disableNetwork, // To manually disable network
            setLogLevel // For debugging Firestore
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Retrieve Firebase config and App ID from global variables ---
        // These variables are expected to be injected into the global scope by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Default for local testing
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Provide your actual Firebase config here for local testing if __firebase_config is not available
            apiKey: "AIzaSyAmiOWe_ECRGpWckAj3-fPtXdloSI31Xe0", // Replace with your actual API key for local testing
            authDomain: "excellence-cbt.firebaseapp.com",
            projectId: "excellence-cbt",
            storageBucket: "excellence-cbt.appspot.com",
            messagingSenderId: "697190795343",
            appId: "1:697190795343:web:0ffb8af3b2fb9e148f823a", // Replace with your actual App ID
            measurementId: "G-836KHSYF0Q" // Replace with your actual Measurement ID
        };
        
        // Initialize Firebase App and Services
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        setLogLevel('debug'); // Enable Firestore debug logging

        // DOM Elements
        const navUserEmailCBT = document.getElementById('navUserEmailCBT');
        const navLogoutCBT = document.getElementById('navLogoutCBT');
        const cbtLoadingMessage = document.getElementById('cbtLoadingMessage');
        const accessDeniedMessage = document.getElementById('accessDeniedMessage');
        const cbtPageContent = document.getElementById('cbtPageContent');
        const questionProgressTextEl = document.getElementById('question-progress-text');
        const progressBarFillEl = document.getElementById('progress-bar-fill');
        const examTimerTopEl = document.getElementById('exam-timer-top');
        const calculatorBtn = document.getElementById('calculator-btn'); // Functionality not implemented in this scope
        const submitExamEarlyBtn = document.getElementById('submit-exam-early-btn');
        const questionNavGridEl = document.getElementById('question-nav-grid');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const activeExamViewEl = document.getElementById('active-exam-view');
        const resultsViewWrapperEl = document.getElementById('results-view-wrapper');
        const quizContentAreaEl = document.getElementById('quiz-content-area');
        const examBottomNavigationEl = document.getElementById('exam-bottom-navigation');
        const toggleNavPanelBtn = document.getElementById('toggle-nav-panel-btn');
        const questionNavigationPanelEl = document.getElementById('question-navigation-panel');
        const viewModeBtn = document.getElementById('view-mode-btn');
        const navAnsweredCountEl = document.getElementById('nav-answered-count');
        const networkStatusIndicator = document.getElementById('network-status-indicator');
        const mainExamContentEl = document.getElementById('main-exam-content'); // Added for margin adjustment

        // Modal Elements
        const submitConfirmationModalEl = document.getElementById('submitConfirmationModal');
        const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
        const cancelSubmitBtn = document.getElementById('cancelSubmitBtn');
        const instructionsModalEl = document.getElementById('instructionsModal');
        const helpBtn = document.getElementById('help-btn');
        const closeInstructionsBtn = document.getElementById('closeInstructionsBtn');
        const gotItInstructionsBtn = document.getElementById('gotItInstructionsBtn');

        // Exam State Variables
        let currentUserId = null; // Will be set after authentication
        let allQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {}; // Store as { questionId: selectedOptionId }
        let questionStatus = []; // Array of 'unseen', 'seen', 'answered'
        let questionFlags = []; // Array of booleans
        let examTimerInterval;
        let timePerQuestionInSecondsDefault = 90; // Default if not set in exam doc
        let totalExamTimeInSeconds = 0;
        let timeLeftInSeconds = 0;
        let examSubmitted = false;
        let currentViewMode = 'single'; // 'single' or 'all'
        let examStartTime = null; // Firestore Timestamp
        let currentLoadedExamId = null;
        let currentLoadedExamTitle = "CBT Exam";
        let activeExamSessionId = null; // Firestore document ID for the active session
        let activeExamSessionUnsubscribe = null; // For Firestore onSnapshot listener

        const EXAM_ID_TO_LOAD_DEFAULT = "Nursing Council Professional Exam"; // Default if no examId in URL
        const SAVE_INTERVAL_MS = 15000; // Save timer progress every 15 seconds
        let lastTimerSaveTime = 0;


        // --- Firestore Collection Paths ---
        const getActiveExamSessionPath = (userId, sessionId) => `artifacts/${appId}/users/${userId}/activeExamSessions/${sessionId}`;
        const getActiveExamSessionsCollectionPath = (userId) => `artifacts/${appId}/users/${userId}/activeExamSessions`;
        const getExamResultsPath = (userId, resultId) => `artifacts/${appId}/users/${userId}/examResults/${resultId}`;
        const getExamResultsCollectionPath = (userId) => `artifacts/${appId}/users/${userId}/examResults`;


        // --- Utility Functions ---
        function formatTime(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // --- Network Status Indicator ---
        function updateNetworkStatus() {
            if (!networkStatusIndicator) return;
            if (navigator.onLine) {
                networkStatusIndicator.textContent = 'Online';
                networkStatusIndicator.classList.remove('offline');
                networkStatusIndicator.classList.add('online');
                enableNetwork(db).catch(err => console.warn("Error enabling network:", err)); 
            } else {
                networkStatusIndicator.textContent = 'Offline';
                networkStatusIndicator.classList.remove('online');
                networkStatusIndicator.classList.add('offline');
            }
        }
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        

        // --- Timer Functions ---
        function updateTimerDisplay() {
            if (examTimerTopEl) examTimerTopEl.textContent = `Time: ${formatTime(timeLeftInSeconds)}`;
        }

        function startExamTimer() {
            if (allQuestions.length === 0 || examSubmitted) {
                stopExamTimer();
                return;
            }
            stopExamTimer(); 

            updateTimerDisplay();

            examTimerInterval = setInterval(async () => {
                if (examSubmitted) {
                    stopExamTimer();
                    return;
                }
                timeLeftInSeconds--;
                updateTimerDisplay();

                if (timeLeftInSeconds <= 0) {
                    console.log("Time's up! Auto-submitting exam.");
                    await submitExam(true); 
                } else {
                    const now = Date.now();
                    if (now - lastTimerSaveTime > SAVE_INTERVAL_MS) {
                        await saveExamState({ timerOnly: true }); 
                        lastTimerSaveTime = now;
                    }
                }
            }, 1000);
        }

        function stopExamTimer() {
            clearInterval(examTimerInterval);
        }

        // --- UI Update Functions ---
        function updateProgressBar() {
            if (!progressBarFillEl || !questionProgressTextEl || !navAnsweredCountEl) return;
            const answeredCount = Object.keys(userAnswers).length; 
            const progressPercent = allQuestions.length > 0 ? ((currentQuestionIndex + 1) / allQuestions.length) * 100 : 0;
            progressBarFillEl.style.width = `${progressPercent}%`;
            questionProgressTextEl.textContent = `Q: ${currentQuestionIndex + 1}/${allQuestions.length}`;
            navAnsweredCountEl.textContent = `${answeredCount}/${allQuestions.length} Answered`;
        }

        function renderQuestionNavigationPanel() {
            if (!questionNavGridEl) return;
            questionNavGridEl.innerHTML = '';
            allQuestions.forEach((question, index) => {
                const navItem = document.createElement('button');
                navItem.className = 'question-nav-item';
                navItem.textContent = index + 1;
                navItem.dataset.questionIndex = index;
                navItem.addEventListener('click', () => jumpToQuestion(index));
                questionNavGridEl.appendChild(navItem);
            });
            updateQuestionNavigationHighlights();
        }

        function updateQuestionNavigationHighlights() {
            if (!questionNavGridEl) return;
            const navItems = questionNavGridEl.querySelectorAll('.question-nav-item');
            navItems.forEach((item, index) => {
                item.classList.remove('current', 'answered', 'seen', 'unseen', 'review-correct', 'review-incorrect', 'review-skipped', 'review-current');
                
                const questionId = allQuestions[index]?.id;
                let baseContent = index + 1;
                
                if (questionFlags[index]) {
                    item.innerHTML = `${baseContent} <i class="fas fa-flag text-xs ml-0.5"></i>`;
                } else {
                    item.textContent = baseContent;
                }

                if (examSubmitted) { 
                    if (questionId && userAnswers[questionId] === allQuestions[index].correctOptionId) {
                        item.classList.add('review-correct');
                    } else if (questionId && userAnswers[questionId] !== undefined) {
                        item.classList.add('review-incorrect');
                    } else {
                        item.classList.add('review-skipped');
                    }
                    if (index === currentQuestionIndex && currentViewMode === 'single') {
                        item.classList.add('review-current');
                    }
                } else { 
                    if (index === currentQuestionIndex && currentViewMode === 'single') {
                        item.classList.add('current');
                    }
                    if (userAnswers[questionId] !== undefined) {
                        item.classList.add('answered');
                    } else if (questionStatus[index] === 'seen') { 
                        item.classList.add('seen');
                    } else {
                        item.classList.add('unseen');
                    }
                }
            });
        }


        function updateNavigationButtons() {
            if(prevQuestionBtn) prevQuestionBtn.disabled = currentQuestionIndex === 0 || examSubmitted;
            if(nextQuestionBtn) {
                nextQuestionBtn.textContent = (currentQuestionIndex === allQuestions.length - 1 && currentViewMode === 'single' && !examSubmitted) ? "Finish" : "Next";
                nextQuestionBtn.disabled = examSubmitted;
                nextQuestionBtn.classList.remove('btn-secondary', 'bg-green-500', 'hover:bg-green-600', 'text-white', 'border-green-500');
                nextQuestionBtn.classList.add('btn-primary');
            }
        }

        // --- Exam State Management with Firestore ---
        async function saveExamState(options = {}) {
            if (examSubmitted || !activeExamSessionId || !currentUserId) return;
            console.log(`Saving exam state to Firestore for session: ${activeExamSessionId}, options:`, options);

            const sessionDocRef = doc(db, getActiveExamSessionPath(currentUserId, activeExamSessionId));
            
            let stateToSave = {
                lastUpdated: serverTimestamp(), 
                timeLeftSeconds: timeLeftInSeconds,
            };

            if (!options.timerOnly) { 
                stateToSave = {
                    ...stateToSave,
                    currentQuestionIndex: currentQuestionIndex,
                    userAnswers: userAnswers, 
                    questionStatus: questionStatus, 
                    questionFlags: questionFlags,   
                    currentViewMode: currentViewMode,
                };
            }
            
            try {
                await updateDoc(sessionDocRef, stateToSave);
                console.log("Exam state saved successfully to Firestore.");
            } catch (error) {
                console.error("Error saving exam state to Firestore:", error);
                if (networkStatusIndicator) {
                    networkStatusIndicator.textContent = 'Save Failed!';
                    networkStatusIndicator.classList.remove('online');
                    networkStatusIndicator.classList.add('offline'); 
                }
            }
        }
        
        // --- Core Exam Logic ---
        async function initializeExam(examIdParam) {
            const urlParams = new URLSearchParams(window.location.search);
            const examIdFromUrl = urlParams.get('examId');
            currentLoadedExamId = examIdParam || examIdFromUrl || EXAM_ID_TO_LOAD_DEFAULT;

            const loadingStatusTextEl = document.getElementById('loadingStatusText');
            if (!currentLoadedExamId) {
                if(loadingStatusTextEl) loadingStatusTextEl.textContent = "Error: Exam ID missing.";
                cbtLoadingMessage.classList.remove('hidden');
                cbtPageContent.classList.add('hidden');
                accessDeniedMessage.classList.add('hidden');
                return;
            }

            if(loadingStatusTextEl) loadingStatusTextEl.textContent = "Checking for active session...";

            try {
                const activeSessionsColRef = collection(db, getActiveExamSessionsCollectionPath(currentUserId));
                const q = query(activeSessionsColRef, 
                                where("examId", "==", currentLoadedExamId),
                                where("status", "==", "in-progress") 
                               );
                const querySnapshot = await getDocs(q);

                let sessionData = null;
                if (!querySnapshot.empty) {
                    const sessionDoc = querySnapshot.docs[0]; 
                    activeExamSessionId = sessionDoc.id;
                    sessionData = sessionDoc.data();
                    console.log(`Resuming active exam session: ${activeExamSessionId}`, sessionData);
                    if(loadingStatusTextEl) loadingStatusTextEl.textContent = "Resuming your session...";

                    allQuestions = sessionData.allQuestionsLoaded || []; 
                    currentLoadedExamTitle = sessionData.examTitle || "CBT Exam";
                    currentQuestionIndex = sessionData.currentQuestionIndex || 0;
                    userAnswers = sessionData.userAnswers || {};
                    questionStatus = sessionData.questionStatus || allQuestions.map(() => 'unseen');
                    questionFlags = sessionData.questionFlags || allQuestions.map(() => false);
                    currentViewMode = sessionData.currentViewMode || 'single';
                    examStartTime = sessionData.startTime; 
                    totalExamTimeInSeconds = sessionData.totalExamTimeSeconds;

                    const lastUpdated = sessionData.lastUpdated ? sessionData.lastUpdated.toDate() : new Date();
                    const serverTimeNow = Date.now(); 
                    const timeElapsedSinceLastSaveMs = serverTimeNow - lastUpdated.getTime();
                    timeLeftInSeconds = Math.max(0, sessionData.timeLeftSeconds - Math.floor(timeElapsedSinceLastSaveMs / 1000));
                    
                    if (allQuestions.length === 0) { 
                         if(loadingStatusTextEl) loadingStatusTextEl.textContent = "Loading exam questions...";
                         await fetchExamQuestionsAndDetails(currentLoadedExamId, true); 
                    }

                } else {
                    console.log("No active session found. Starting new exam.");
                    if(loadingStatusTextEl) loadingStatusTextEl.textContent = "Loading exam questions...";
                    await fetchExamQuestionsAndDetails(currentLoadedExamId, false); 

                    activeExamSessionId = doc(collection(db, "some_temporary_placeholder")).id; // Generate client-side ID first
                    const newSessionData = {
                        userId: currentUserId,
                        examId: currentLoadedExamId,
                        examTitle: currentLoadedExamTitle,
                        startTime: serverTimestamp(),
                        lastUpdated: serverTimestamp(),
                        totalExamTimeSeconds: totalExamTimeInSeconds,
                        timeLeftSeconds: totalExamTimeInSeconds,
                        currentQuestionIndex: 0,
                        userAnswers: {},
                        questionStatus: allQuestions.map(() => 'unseen'),
                        questionFlags: allQuestions.map(() => false),
                        status: "in-progress",
                        currentViewMode: 'single',
                        allQuestionsLoaded: allQuestions 
                    };
                    // Use the generated ID to set the document in the correct user-specific path
                    await setDoc(doc(db, getActiveExamSessionPath(currentUserId, activeExamSessionId)), newSessionData);
                    console.log(`New exam session created: ${activeExamSessionId}`);
                    timeLeftInSeconds = totalExamTimeInSeconds; 
                    examStartTime = Timestamp.now(); 
                }

                examSubmitted = false;
                if(viewModeBtn) { viewModeBtn.textContent = currentViewMode === 'single' ? 'View All' : 'One by One'; viewModeBtn.disabled = false; }
                if(submitExamEarlyBtn) submitExamEarlyBtn.disabled = false;
                if(examTimerTopEl) examTimerTopEl.classList.remove('hidden');
                if(resultsViewWrapperEl) resultsViewWrapperEl.classList.add('hidden');
                if(activeExamViewEl) activeExamViewEl.classList.remove('hidden');
                if(quizContentAreaEl) quizContentAreaEl.innerHTML = '';
                if(examBottomNavigationEl) examBottomNavigationEl.classList.remove('hidden');

                renderQuestionNavigationPanel();
                renderCurrentView();
                updateNavigationButtons();
                startExamTimer(); 

                cbtPageContent.classList.remove('hidden');
                cbtLoadingMessage.classList.add('hidden');
                accessDeniedMessage.classList.add('hidden');

            } catch (error) {
                console.error("Error initializing exam (Firestore state):", error);
                if(loadingStatusTextEl) loadingStatusTextEl.textContent = "Error loading exam. Try again.";
                cbtLoadingMessage.classList.remove('hidden');
                cbtPageContent.classList.add('hidden');
            }
        }
        
        async function fetchExamQuestionsAndDetails(examId, isResuming = false) {
            try {
                const examDocRef = doc(db, "cbtExams", examId);
                const examDocSnap = await getDoc(examDocRef);

                if (examDocSnap.exists()) {
                    currentLoadedExamTitle = examDocSnap.data().title || "CBT Exam";
                    timePerQuestionInSecondsDefault = examDocSnap.data().timePerQuestion || 90;
                } else {
                    console.warn(`Exam document ${examId} not found in cbtExams. Using defaults.`);
                    currentLoadedExamTitle = "CBT Exam (Default)";
                }

                const questionsRef = collection(db, "cbtExams", examId, "questions");
                const qQuery = query(questionsRef); 
                const querySnapshot = await getDocs(qQuery);
                
                allQuestions = []; 
                querySnapshot.forEach((doc) => {
                    allQuestions.push({ id: doc.id, ...doc.data() });
                });

                if (!isResuming) { 
                    questionStatus = allQuestions.map(() => 'unseen');
                    questionFlags = allQuestions.map(() => false);
                    userAnswers = {};
                    currentQuestionIndex = 0;
                    totalExamTimeInSeconds = allQuestions.length * timePerQuestionInSecondsDefault;
                } else if (allQuestions.length > 0 && Object.keys(questionStatus).length !== allQuestions.length) {
                    // This part might need sessionData if it was available before calling this
                    // For now, let's assume if isResuming, sessionData was handled by initializeExam
                    // and this function is mainly for fetching questions if not in sessionData.allQuestionsLoaded
                    const sessionDocRef = doc(db, getActiveExamSessionPath(currentUserId, activeExamSessionId));
                    const sessionDocSnap = await getDoc(sessionDocRef);
                    if (sessionDocSnap.exists()) {
                        const existingSessionData = sessionDocSnap.data();
                        questionStatus = existingSessionData.questionStatus || allQuestions.map(() => 'unseen');
                        questionFlags = existingSessionData.questionFlags || allQuestions.map(() => false);
                    } else {
                         questionStatus = allQuestions.map(() => 'unseen');
                         questionFlags = allQuestions.map(() => false);
                    }
                }


                if (allQuestions.length === 0) {
                    throw new Error("No questions found for this exam.");
                }
            } catch (error) {
                console.error(`Error fetching questions for exam ${examId}:`, error);
                throw error; 
            }
        }


        function renderCurrentView() {
             if (examSubmitted) {
                renderResultsPage(); 
                return;
             }
            if(resultsViewWrapperEl) resultsViewWrapperEl.classList.add('hidden');
            if(activeExamViewEl) activeExamViewEl.classList.remove('hidden');

            if (currentViewMode === 'single') {
                if (quizContentAreaEl) quizContentAreaEl.className = 'single-question-view';
                displaySingleQuestion();
                if (examBottomNavigationEl) examBottomNavigationEl.classList.remove('hidden');
            } else { 
                if (quizContentAreaEl) quizContentAreaEl.className = 'all-questions-view';
                displayAllQuestions();
                if (examBottomNavigationEl) examBottomNavigationEl.classList.add('hidden');
            }
        }

        function createFlagButton(questionIndex, uniqueIdPart) {
            const flagBtn = document.createElement('button');
            flagBtn.id = `flag-btn-${uniqueIdPart}-${questionIndex}`;
            flagBtn.className = `btn btn-sm !py-0.5 !px-1.5 !text-xs ${questionFlags[questionIndex] ? 'btn-warning' : 'btn-secondary'}`;
            flagBtn.title = questionFlags[questionIndex] ? "Unflag" : "Flag";
            flagBtn.innerHTML = `<i class="fas fa-flag mr-0.5"></i> ${questionFlags[questionIndex] ? 'Flagged' : 'Flag'}`;
            
            flagBtn.addEventListener('click', async (event) => {
                event.stopPropagation();
                if (examSubmitted) return;
                questionFlags[questionIndex] = !questionFlags[questionIndex];
                flagBtn.innerHTML = `<i class="fas fa-flag mr-0.5"></i> ${questionFlags[questionIndex] ? 'Flagged' : 'Flag'}`;
                flagBtn.classList.toggle('btn-warning', questionFlags[questionIndex]);
                flagBtn.classList.toggle('btn-secondary', !questionFlags[questionIndex]);
                
                updateQuestionNavigationHighlights();
                await saveExamState(); 
            });
            return flagBtn;
        }

        function displaySingleQuestion() {
            if (allQuestions.length === 0 || currentQuestionIndex < 0 || currentQuestionIndex >= allQuestions.length || !quizContentAreaEl) return;
            const question = allQuestions[currentQuestionIndex];
            if (!question || !question.id) {
                console.error("Invalid question data at current index:", currentQuestionIndex, question);
                quizContentAreaEl.innerHTML = `<p class="text-red-500 text-center p-4">Error: Could not load question ${currentQuestionIndex + 1}.</p>`;
                return;
            }

            if (questionStatus[currentQuestionIndex] === 'unseen') {
                questionStatus[currentQuestionIndex] = 'seen';
            }

            const flagButton = createFlagButton(currentQuestionIndex, `single_${question.id}`);
            
            quizContentAreaEl.innerHTML = `
                <div id="question-container">
                    <p id="examTitleContextInPage">${currentLoadedExamTitle}</p>
                    <div class="question-header-actions"></div>
                    <p id="question-text">${question.questionText}</p>
                </div>
                <div id="options-container" class="mt-3"> 
                    ${(question.options && Array.isArray(question.options)) ? question.options.map(option => `
                        <label class="quiz-option-label" for="option_single_${question.id}_${option.id}">
                            <input type="radio" name="question_single_${question.id}" value="${option.id}" class="quiz-option-input mr-2" id="option_single_${question.id}_${option.id}" 
                                   ${userAnswers[question.id] === option.id ? 'checked' : ''}>
                            ${option.id}. ${option.text}
                        </label>
                    `).join('') : '<p class="text-red-500 text-sm">Options not available.</p>'}
                </div>`;
            
            const headerActionsContainer = quizContentAreaEl.querySelector('.question-header-actions');
            if (headerActionsContainer) headerActionsContainer.appendChild(flagButton);

            const optionLabels = quizContentAreaEl.querySelectorAll('.quiz-option-label');
            optionLabels.forEach(label => {
                const radio = label.querySelector('input[type="radio"]');
                if (radio && userAnswers[question.id] === radio.value) {
                    label.classList.add('selected');
                }
                label.addEventListener('click', async () => {
                    if (examSubmitted) return;
                    if (radio) {
                        radio.checked = true;
                        userAnswers[question.id] = radio.value; 
                        questionStatus[currentQuestionIndex] = 'answered'; 
                    }
                    optionLabels.forEach(lbl => lbl.classList.remove('selected'));
                    label.classList.add('selected');
                    updateQuestionNavigationHighlights();
                    updateProgressBar();
                    await saveExamState(); 
                });
            });
            updateQuestionNavigationHighlights();
            updateProgressBar();
        }

        function displayAllQuestions() {
            if (!quizContentAreaEl) return;
            quizContentAreaEl.innerHTML = '';
            allQuestions.forEach((question, index) => {
                if (!question || !question.id) {
                    console.error("Invalid question data at index for 'all questions' view:", index, question);
                    const errorBlock = document.createElement('div');
                    errorBlock.className = 'question-block p-4 text-red-500 text-center';
                    errorBlock.textContent = `Error: Could not load question ${index + 1}.`;
                    quizContentAreaEl.appendChild(errorBlock);
                    return; 
                }

                const questionBlock = document.createElement('div');
                questionBlock.className = 'question-block';
                questionBlock.id = `q-block-${index}`;

                let optionsHTML = (question.options && Array.isArray(question.options)) ? 
                    question.options.map(option => `
                        <label class="quiz-option-label ${userAnswers[question.id] === option.id ? 'selected' : ''}" 
                               for="option_all_${question.id}_${option.id}">
                            <input type="radio" name="question_all_${question.id}" value="${option.id}" 
                                   class="quiz-option-input mr-2" id="option_all_${question.id}_${option.id}" 
                                   ${userAnswers[question.id] === option.id ? 'checked' : ''}>
                            ${option.id}. ${option.text}
                        </label>
                    `).join('') : '<p class="text-red-500 text-sm">Options not available.</p>';

                const flagButtonInAllView = createFlagButton(index, `all_${question.id}`);
                
                questionBlock.innerHTML = `
                    <div id="question-container">
                        <div class="flex justify-between items-center">
                            <p class="single-question-text-header">Q ${index + 1}</p>
                            <div class="question-header-actions-allview"></div>
                        </div>
                        <p id="question-text">${question.questionText}</p>
                    </div>
                    <div class="single-question-options mt-3">${optionsHTML}</div>`;
                quizContentAreaEl.appendChild(questionBlock);
                
                const headerActionsContainerAllView = questionBlock.querySelector('.question-header-actions-allview');
                if (headerActionsContainerAllView) headerActionsContainerAllView.appendChild(flagButtonInAllView);

                const optionLabelsInBlock = questionBlock.querySelectorAll('.quiz-option-label');
                optionLabelsInBlock.forEach(label => {
                    const radio = label.querySelector('input[type="radio"]');
                    label.addEventListener('click', async () => {
                        if (examSubmitted) return;
                        if (radio) {
                            radio.checked = true;
                            userAnswers[question.id] = radio.value; 
                            questionStatus[index] = 'answered';
                        }
                        const parentBlock = label.closest('.question-block');
                        if (parentBlock) {
                            parentBlock.querySelectorAll('.quiz-option-label').forEach(lbl => lbl.classList.remove('selected'));
                        }
                        label.classList.add('selected');
                        updateQuestionNavigationHighlights();
                        updateProgressBar();
                        await saveExamState(); 
                    });
                });
                if (questionStatus[index] === 'unseen') {
                     questionStatus[index] = 'seen';
                }
            });
            updateQuestionNavigationHighlights();
            updateProgressBar();
        }

        async function jumpToQuestion(index) {
            if (index >= 0 && index < allQuestions.length) {
                currentQuestionIndex = index;
                if (currentViewMode === 'single') {
                    if (examSubmitted) {
                        displaySingleReviewedQuestion(); 
                        const targetBlock = document.getElementById(`review-q-block-${index}`);
                        if(targetBlock) targetBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        else { const resultsContainer = document.getElementById('results-view-wrapper'); if(resultsContainer) resultsContainer.scrollTop = 0; }
                    } else {
                        displaySingleQuestion();
                        if (quizContentAreaEl) quizContentAreaEl.scrollTop = 0;
                    }
                } else { 
                    const questionBlockId = examSubmitted ? `review-q-block-${index}` : `q-block-${index}`;
                    const questionBlock = document.getElementById(questionBlockId);
                    if (questionBlock) {
                        questionBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        if (!examSubmitted && questionStatus[index] === 'unseen') {
                            questionStatus[index] = 'seen';
                        }
                    }
                }
                if (!examSubmitted) {
                    updateNavigationButtons();
                    updateQuestionNavigationHighlights();
                    updateProgressBar();
                    await saveExamState(); 
                }
            }
        }

        // --- Event Listeners for Navigation and Actions ---
        if(nextQuestionBtn) {
            nextQuestionBtn.addEventListener('click', async () => {
                if (examSubmitted) return;
                if (currentQuestionIndex < allQuestions.length - 1) {
                    currentQuestionIndex++;
                    displaySingleQuestion();
                    await saveExamState(); 
                } else if (currentViewMode === 'single' && currentQuestionIndex === allQuestions.length -1) { // Added check for single view mode
                    openSubmitModal();
                }
                updateNavigationButtons();
            });
        }
        if(prevQuestionBtn) {
            prevQuestionBtn.addEventListener('click', async () => {
                if (examSubmitted) return;
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displaySingleQuestion();
                    updateNavigationButtons();
                    await saveExamState(); 
                }
            });
        }

        if(submitExamEarlyBtn) submitExamEarlyBtn.addEventListener('click', () => { if (examSubmitted) return; openSubmitModal(); });
        if(calculatorBtn) calculatorBtn.addEventListener('click', () => { alert("Calculator functionality coming soon!"); });

        if(toggleNavPanelBtn) {
            toggleNavPanelBtn.addEventListener('click', () => {
                const isDesktop = window.innerWidth > 768;
                if (isDesktop) {
                    questionNavigationPanelEl.classList.toggle('hidden-desktop');
                    if (mainExamContentEl) {
                         mainExamContentEl.style.marginLeft = questionNavigationPanelEl.classList.contains('hidden-desktop') ? '0' : questionNavigationPanelEl.offsetWidth + 'px';
                    }
                } else { // Mobile
                    questionNavigationPanelEl.classList.toggle('mobile-visible');
                }
                toggleNavPanelBtn.innerHTML = (questionNavigationPanelEl.classList.contains('hidden-desktop') || !questionNavigationPanelEl.classList.contains('mobile-visible')) ? '<i class="fas fa-bars"></i>' : '<i class="fas fa-times"></i>';
                toggleNavPanelBtn.title = (questionNavigationPanelEl.classList.contains('hidden-desktop') || !questionNavigationPanelEl.classList.contains('mobile-visible')) ? "Show Nav" : "Hide Nav";
            });
        }
        if (viewModeBtn) {
            viewModeBtn.addEventListener('click', async () => {
                if (examSubmitted) { 
                    currentViewMode = currentViewMode === 'single' ? 'all' : 'single';
                    viewModeBtn.textContent = currentViewMode === 'single' ? "All (Review)" : "One by One (Review)";
                    viewModeBtn.title = currentViewMode === 'single' ? "All Questions Review" : "One by One Review";
                    if (currentViewMode === 'single') {
                        currentQuestionIndex = 0; 
                        displaySingleReviewedQuestion();
                    } else {
                        renderDetailedReview(document.querySelector('#review-filter-buttons .btn-filter.active')?.dataset.filter || 'all');
                    }
                    return;
                }
                currentViewMode = currentViewMode === 'single' ? 'all' : 'single';
                viewModeBtn.textContent = currentViewMode === 'single' ? 'View All' : 'One by One';
                viewModeBtn.title = currentViewMode === 'single' ? 'All Questions View' : 'One by One View';
                renderCurrentView();
                updateNavigationButtons();
                await saveExamState(); 
            });
        }

        // Modal Functions & Event Listeners
        function openSubmitModal() { if(submitConfirmationModalEl) submitConfirmationModalEl.classList.add('active'); }
        function closeSubmitModal() { if(submitConfirmationModalEl) submitConfirmationModalEl.classList.remove('active');}
        function openInstructionsModal() { if(instructionsModalEl) instructionsModalEl.classList.add('active'); }
        function closeInstructionsModal() { if(instructionsModalEl) instructionsModalEl.classList.remove('active'); }

        if(confirmSubmitBtn) confirmSubmitBtn.addEventListener('click', () => { submitExam(); closeSubmitModal(); });
        if(cancelSubmitBtn) cancelSubmitBtn.addEventListener('click', closeSubmitModal);
        if(helpBtn) helpBtn.addEventListener('click', openInstructionsModal);
        if(closeInstructionsBtn) closeInstructionsBtn.addEventListener('click', closeInstructionsModal);
        if(gotItInstructionsBtn) gotItInstructionsBtn.addEventListener('click', closeInstructionsModal);

        // --- Results Page Logic ---
        async function renderResultsPage(timedOut = false) {
            examSubmitted = true; 
            stopExamTimer();
            if(activeExamViewEl) activeExamViewEl.classList.add('hidden');
            if(resultsViewWrapperEl) resultsViewWrapperEl.classList.remove('hidden');
            if(examTimerTopEl) examTimerTopEl.classList.add('hidden');
            if(submitExamEarlyBtn) { submitExamEarlyBtn.disabled = true; submitExamEarlyBtn.classList.add('hidden');}
            if(viewModeBtn) { viewModeBtn.disabled = false; currentViewMode = 'all'; viewModeBtn.textContent = "One by One (Review)"; viewModeBtn.title = "One by One Review"; }
            if(examBottomNavigationEl) examBottomNavigationEl.classList.add('hidden');

            let score = 0, correctCount = 0, wrongCount = 0, skippedCount = 0;
            const examDate = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            
            let timeSpentFormatted = "N/A";
            if (examStartTime && typeof examStartTime.toDate === 'function') {
                const endTime = Date.now();
                const startTimeMs = examStartTime.toDate().getTime();
                const timeSpentMs = endTime - startTimeMs;
                timeSpentFormatted = formatTime(Math.max(0, Math.floor(timeSpentMs / 1000)));
            } else { 
                const timeTaken = totalExamTimeInSeconds - timeLeftInSeconds;
                timeSpentFormatted = formatTime(Math.max(0, timeTaken));
            }


            allQuestions.forEach((q, index) => {
                const userAnswer = userAnswers[q.id]; 
                if (userAnswer === q.correctOptionId) {
                    correctCount++;
                    questionStatus[index] = 'correct'; 
                } else if (userAnswer !== undefined) {
                    wrongCount++;
                    questionStatus[index] = 'incorrect';
                } else {
                    skippedCount++;
                    questionStatus[index] = 'skipped';
                }
            });
            score = correctCount;
            updateQuestionNavigationHighlights(); 

            const percentageScore = allQuestions.length > 0 ? ((score / allQuestions.length) * 100).toFixed(1) : 0;
            const percentageContainerClass = parseFloat(percentageScore) >= 50 ? 'score-percentage-container pass' : 'score-percentage-container fail';
            
            let summaryHTML = `
                <div class="results-summary-card">
                    <h2 class="text-2xl">Exam Results</h2>
                    <p class="text-xs text-gray-500 mb-2">For: ${currentLoadedExamTitle} | Date: ${examDate}</p>
                    ${timedOut ? "<p class='text-red-500 font-semibold mb-2 text-sm'>Time's up! Auto-submitted.</p>" : ""}
                    <div class="score-display-grid">
                        <div class="score-overall">
                            <div class="score-value-main">${score}/${allQuestions.length}</div>
                            <div class="${percentageContainerClass} mt-1"><p class="score-percentage-main">${percentageScore}%</p></div>
                        </div>
                        <ul class="score-breakdown-list text-xs">
                            <li><span class="label correct">Correct</span><span class="count">${correctCount}</span></li>
                            <li><span class="label wrong">Wrong</span><span class="count">${wrongCount}</span></li>
                            <li><span class="label skipped">Skipped</span><span class="count">${skippedCount}</span></li>
                            <li class="pt-1 mt-1 border-t"><span class="label">Time Spent</span><span class="count">${timeSpentFormatted}</span></li>
                            <li><span class="label">Total Time</span><span class="count">${formatTime(totalExamTimeInSeconds)}</span></li>
                        </ul>
                    </div>
                    <div class="mt-4">
                        <button id="retakeExamBtnResults" class="btn btn-primary !text-xs">Retake Exam</button>
                        <a href="index.html" class="btn btn-secondary !text-xs mt-2 sm:mt-0 sm:ml-2">Back to Home</a>
                    </div>
                </div>
                <div id="review-filter-buttons" class="my-3 flex justify-center gap-1 flex-wrap">
                    <button class="btn btn-filter active" data-filter="all">All</button>
                    <button class="btn btn-filter" data-filter="correct">Correct</button>
                    <button class="btn btn-filter" data-filter="incorrect">Incorrect</button>
                    <button class="btn btn-filter" data-filter="skipped">Skipped</button>
                    <button class="btn btn-filter" data-filter="flagged">Flagged</button>
                </div>
                <div id="detailed-results-container"></div>`;
            
            if(resultsViewWrapperEl) resultsViewWrapperEl.innerHTML = summaryHTML;

            const retakeBtn = document.getElementById('retakeExamBtnResults');
            if (retakeBtn) {
                retakeBtn.addEventListener('click', () => {
                    if(cbtLoadingMessage) cbtLoadingMessage.classList.remove('hidden');
                    if(cbtPageContent) cbtPageContent.classList.add('hidden');
                    const loadingStatusTextEl = document.getElementById('loadingStatusText');
                    if(loadingStatusTextEl) loadingStatusTextEl.textContent = "Restarting exam...";
                    activeExamSessionId = null; 
                    initializeExam(currentLoadedExamId);
                });
            }

            document.querySelectorAll('#review-filter-buttons .btn-filter').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('#review-filter-buttons .btn-filter').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderDetailedReview(e.target.dataset.filter);
                });
            });
            renderDetailedReview('all'); 
        }

        function displaySingleReviewedQuestion() {
            const container = document.getElementById('detailed-results-container');
            if (!container || allQuestions.length === 0 || !examSubmitted) return;
            if (currentQuestionIndex < 0 || currentQuestionIndex >= allQuestions.length) currentQuestionIndex = 0;

            const q = allQuestions[currentQuestionIndex];
            const userAnswer = userAnswers[q.id]; 

            let optionsHTML = (q.options && Array.isArray(q.options)) ? q.options.map(opt => {
                let liClass = 'result-option';
                let indicator = '';
                if (opt.id === q.correctOptionId) {
                    liClass += ' correct-answer-style';
                    indicator = ' <i class="fas fa-check text-green-500 text-xs"></i> (Correct)';
                }
                if (userAnswer === opt.id) {
                    liClass += ' user-selected-style';
                    if (opt.id === q.correctOptionId) {
                        indicator += ' (Your Pick)';
                    } else {
                        liClass += ' incorrect-answer-style';
                        indicator = ` <i class="fas fa-times text-red-500 text-xs"></i> (Your Pick)${indicator.includes('(Correct)') ? indicator.replace(' (Correct)', '') : ''}`;
                    }
                }
                return `<li class="${liClass}"><span class="result-option-text">${opt.id}. ${opt.text}</span><span class="result-option-indicator">${indicator}</span></li>`;
            }).join('') : '<li>No options.</li>';

            container.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-700 my-2 text-center font-montserrat">Reviewing Q ${currentQuestionIndex + 1}/${allQuestions.length}</h3>
                <div class="result-question-item" id="review-q-block-${currentQuestionIndex}">
                    <div class="result-question-text-container">
                        <div class="flex justify-between items-center">
                            <p class="result-question-text">${currentQuestionIndex + 1}. ${q.questionText}</p>
                            ${questionFlags[currentQuestionIndex] ? '<i class="fas fa-flag text-red-500 text-xs" title="Flagged"></i>' : ''}
                        </div>
                    </div>
                    <ul class="result-options-list">${optionsHTML}</ul>
                    ${q.rationale ? `<div class="result-rationale"><strong>Rationale:</strong> ${q.rationale}</div>` : ''}
                </div>`;
            
            if(examBottomNavigationEl) { 
                 examBottomNavigationEl.classList.remove('hidden');
                 if(prevQuestionBtn) prevQuestionBtn.disabled = currentQuestionIndex === 0;
                 if(nextQuestionBtn) {
                    nextQuestionBtn.textContent = (currentQuestionIndex === allQuestions.length - 1) ? "End Review" : "Next";
                    nextQuestionBtn.disabled = false; 
                 }
            }
            updateQuestionNavigationHighlights(); 
        }

        function renderDetailedReview(filter = 'all') {
            const container = document.getElementById('detailed-results-container');
            if (!container || !examSubmitted) return;

            if (currentViewMode === 'single' && examSubmitted) {
                displaySingleReviewedQuestion();
                if(examBottomNavigationEl) examBottomNavigationEl.classList.remove('hidden'); 
                return;
            }
            if(examBottomNavigationEl) examBottomNavigationEl.classList.add('hidden'); 

            let reviewHTML = `<h3 class="text-lg font-semibold text-gray-700 my-3 text-center font-montserrat hidden">Detailed Review (${filter})</h3>`;
            reviewHTML += allQuestions.filter((q, index) => {
                const isCorrect = userAnswers[q.id] === q.correctOptionId;
                const isAnswered = userAnswers[q.id] !== undefined;
                const isSkipped = !isAnswered;
                if (filter === 'all') return true;
                if (filter === 'correct') return isCorrect;
                if (filter === 'incorrect') return isAnswered && !isCorrect;
                if (filter === 'skipped') return isSkipped;
                if (filter === 'flagged') return questionFlags[index];
                return true;
            })
            .map((q, filteredArrayIndex) => { 
                const originalIndex = allQuestions.findIndex(aq => aq.id === q.id); 
                const userAnswer = userAnswers[q.id];
                
                return `
                    <div class="result-question-item" id="review-q-block-${originalIndex}">
                        <div class="result-question-text-container">
                            <div class="flex justify-between items-center">
                                <p class="result-question-text">${originalIndex + 1}. ${q.questionText}</p>
                                ${questionFlags[originalIndex] ? '<i class="fas fa-flag text-red-500 text-xs" title="Flagged"></i>' : ''}
                            </div>
                        </div>
                        <ul class="result-options-list">
                            ${(q.options && Array.isArray(q.options) ? q.options.map(opt => {
                                let liClass = 'result-option';
                                let indicator = '';
                                if (opt.id === q.correctOptionId) {
                                    liClass += ' correct-answer-style';
                                    indicator = ' <i class="fas fa-check text-green-500 text-xs"></i> (Correct)';
                                }
                                if (userAnswer === opt.id) {
                                    liClass += ' user-selected-style';
                                    if (opt.id === q.correctOptionId) {
                                        indicator += ' (Your Pick)';
                                    } else {
                                        liClass += ' incorrect-answer-style';
                                        indicator = ` <i class="fas fa-times text-red-500 text-xs"></i> (Your Pick)${indicator.includes('(Correct)') ? indicator.replace(' (Correct)', '') : ''}`;
                                    }
                                }
                                return `<li class="${liClass}"><span class="result-option-text">${opt.id}. ${opt.text}</span><span class="result-option-indicator">${indicator}</span></li>`;
                            }).join('') : '<li>No options.</li>')}
                        </ul>
                        ${q.rationale ? `<div class="result-rationale"><strong>Rationale:</strong> ${q.rationale}</div>` : ''}
                    </div>`;
            }).join('');
            container.innerHTML = reviewHTML;
        }

        async function submitExam(timedOut = false) {
            if (examSubmitted && !timedOut) return; 
            examSubmitted = true;
            stopExamTimer();
            
            console.log("Submitting exam. Timed out:", timedOut);

            if (activeExamSessionId && currentUserId) {
                const sessionDocRef = doc(db, getActiveExamSessionPath(currentUserId, activeExamSessionId));
                try {
                    await updateDoc(sessionDocRef, {
                        status: "submitted",
                        timeLeftSeconds: Math.max(0, timeLeftInSeconds), 
                        userAnswers: userAnswers,
                        questionStatus: questionStatus,
                        questionFlags: questionFlags,
                        submissionType: timedOut ? "timed_out" : "manual",
                        submittedAt: serverTimestamp()
                    });
                    console.log("Active exam session marked as submitted in Firestore.");

                } catch (error) {
                    console.error("Error updating exam session to submitted in Firestore:", error);
                }
            }
            renderResultsPage(timedOut);
        }


        // --- User Authentication and Subscription Check ---
        async function checkUserSubscription(userIdToCheck) {
            if (!userIdToCheck) return false;
            try {
                const subscriptionsRef = collection(db, "userSubscriptions", userIdToCheck, "activePlans");
                const now = Timestamp.now();
                const q = query(subscriptionsRef, 
                                where("status", "==", "active"),
                                where("expiryDate", ">", now));
                const querySnapshot = await getDocs(q);
                return !querySnapshot.empty;
            } catch (error) {
                console.error("cbt_exam.html - Error checking subscription:", error);
                return false; 
            }
        }

        onAuthStateChanged(auth, async (user) => {
            updateNetworkStatus(); 
            const loadingStatusTextEl = document.getElementById('loadingStatusText');
            if (user) {
                currentUserId = user.uid; 
                if(navUserEmailCBT) { navUserEmailCBT.textContent = user.email; navUserEmailCBT.classList.add('active'); }
                if(navLogoutCBT) navLogoutCBT.classList.add('active');
                
                if(loadingStatusTextEl) loadingStatusTextEl.textContent = "Verifying subscription...";
                const hasActiveSubscription = await checkUserSubscription(currentUserId);

                if (hasActiveSubscription) {
                    accessDeniedMessage.classList.add('hidden');
                    await initializeExam(); 
                } else {
                    cbtPageContent.classList.add('hidden');
                    cbtLoadingMessage.classList.add('hidden');
                    accessDeniedMessage.classList.remove('hidden');
                }
            } else { 
                currentUserId = null;
                if(navUserEmailCBT) navUserEmailCBT.classList.remove('active');
                if(navLogoutCBT) navLogoutCBT.classList.remove('active');
                
                cbtPageContent.classList.add('hidden');
                accessDeniedMessage.classList.add('hidden');
                if(cbtLoadingMessage) {
                    cbtLoadingMessage.classList.remove('hidden');
                    if(loadingStatusTextEl) loadingStatusTextEl.innerHTML = '<p class="text-lg text-red-500">Access Denied. Please log in. Redirecting...</p>';
                }
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting sign-in with custom token...");
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Successfully signed in with custom token.");
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        if(loadingStatusTextEl) loadingStatusTextEl.innerHTML = '<p class="text-lg text-red-500">Authentication error. Please try logging in manually.</p>';
                        setTimeout(() => { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`; }, 3000);
                    }
                } else {
                    console.log("No custom token, redirecting to login page.");
                    sessionStorage.setItem('redirectAfterLogin', window.location.href);
                    setTimeout(() => { window.location.href = 'login.html'; }, 2500);
                }
            }
        });
        
        if (navLogoutCBT) {
            navLogoutCBT.addEventListener('click', async () => {
                if (activeExamSessionId && !examSubmitted) {
                    console.log("Attempting to save final state before logout...");
                    await saveExamState({ timerOnly: false }); 
                }
                if (activeExamSessionUnsubscribe) {
                    activeExamSessionUnsubscribe(); 
                }
                signOut(auth).catch((error) => console.error("Sign out error:", error));
            });
        }

        // Initial setup for nav panel visibility based on screen size
        function initialNavPanelSetup() {
            const isDesktop = window.innerWidth > 768;
            if (questionNavigationPanelEl && mainExamContentEl) { // Added mainExamContentEl check
                if (isDesktop) {
                    questionNavigationPanelEl.classList.remove('hidden-desktop', 'mobile-visible');
                    mainExamContentEl.style.marginLeft = questionNavigationPanelEl.offsetWidth + 'px';
                    toggleNavPanelBtn.innerHTML = '<i class="fas fa-times"></i>';
                    toggleNavPanelBtn.title = "Hide Nav";
                } else { // Mobile
                    questionNavigationPanelEl.classList.remove('hidden-desktop', 'mobile-visible'); // Ensure it starts hidden on mobile correctly
                    mainExamContentEl.style.marginLeft = '0';
                    toggleNavPanelBtn.innerHTML = '<i class="fas fa-bars"></i>';
                    toggleNavPanelBtn.title = "Show Nav";
                }
            }
        }
        window.addEventListener('load', initialNavPanelSetup);
        window.addEventListener('resize', initialNavPanelSetup);

        document.addEventListener('visibilitychange', async () => {
            if (!activeExamSessionId || examSubmitted || !currentUserId) return;

            if (document.visibilityState === 'hidden') {
                console.log("Page hidden, ensuring exam state is saved.");
                stopExamTimer(); 
                await saveExamState({ timerOnly: false }); 
            } else if (document.visibilityState === 'visible') {
                console.log("Page visible, re-syncing exam state and resuming timer.");
                const sessionDocRef = doc(db, getActiveExamSessionPath(currentUserId, activeExamSessionId));
                try {
                    const docSnap = await getDoc(sessionDocRef);
                    if (docSnap.exists()) {
                        const sessionData = docSnap.data();
                        if (sessionData.status === "in-progress") {
                            currentQuestionIndex = sessionData.currentQuestionIndex;
                            userAnswers = sessionData.userAnswers;
                            questionStatus = sessionData.questionStatus;
                            questionFlags = sessionData.questionFlags;
                            
                            const lastUpdated = sessionData.lastUpdated.toDate();
                            const serverTimeNow = Date.now(); 
                            const timeElapsedSinceLastSaveMs = serverTimeNow - lastUpdated.getTime();
                            timeLeftInSeconds = Math.max(0, sessionData.timeLeftSeconds - Math.floor(timeElapsedSinceLastSaveMs / 1000));
                            
                            renderCurrentView(); 
                            updateNavigationButtons();
                            updateProgressBar();
                            updateQuestionNavigationHighlights();
                            startExamTimer(); 
                        } else if (sessionData.status === "submitted") {
                            examSubmitted = true;
                            renderResultsPage(sessionData.submissionType === "timed_out");
                        }
                    }
                } catch (error) {
                    console.error("Error re-syncing exam state on visibility change:", error);
                }
            }
        });

    </script>
</body>
</html>
